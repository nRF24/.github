name: Build Docs

on:
  workflow_call:
    inputs:
      repo-name:
        required: true
        type: string
      lib-version:
        required: true
        type: string
      mk-sphinx:
        required: false
        default: false
        type: boolean

jobs:
  build-doxygen:
    runs-on: ubuntu-latest
    steps:
      - name: install Doxygen static libclang deps
        run: sudo apt-get install libclang1-12 libclang-cpp12
      - name: install doxygen from SF binary archives
        env:
          DOXYGEN_VERSION: '1.9.6'
        run: |
          mkdir .doxygen && cd .doxygen
          curl -L https://sourceforge.net/projects/doxygen/files/rel-$DOXYGEN_VERSION/doxygen-$DOXYGEN_VERSION.linux.bin.tar.gz > doxygen.tar.gz
          gunzip doxygen.tar.gz
          tar xf doxygen.tar
          cd doxygen-$DOXYGEN_VERSION
          sudo make install
      - uses: actions/checkout@v3
      - name: overwrite doxygen tags
        working-directory: docs
        run: |
          touch doxygenAction
          echo "PROJECT_NUMBER = ${{ inputs.lib-version }}" >> doxygenAction
          echo -e "\n@INCLUDE = doxygenAction" >> Doxyfile

      - run: doxygen
        working-directory: docs

      - name: Save doxygen docs as artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.repo-name }}_doxygen_docs
          path: ${{ github.workspace }}/docs/html

      - name: Save doxygen XML as artifact
        if: inputs.mk-sphinx
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.repo-name }}_doxygen_xml
          path: ${{ github.workspace }}/docs/sphinx/xml

  build-sphinx:
    if: inputs.mk-sphinx
    needs: [build-doxygen]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v4
        with:
          python-version: 3.x
      - uses: actions/checkout@v3
      - name: download XML artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.repo-name }}_doxygen_xml
          path: ${{ github.workspace }}/docs/sphinx/xml
      - name: Install sphinx deps
        run: python -m pip install -r docs/sphinx/requirements.txt
      - name: build docs with Sphinx
        working-directory: docs
        run: sphinx-build sphinx _build
      - name: Save sphinx docs as artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.repo-name }}_sphinx_docs
          path: ${{ github.workspace }}/docs/_build
